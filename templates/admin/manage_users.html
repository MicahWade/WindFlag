{% extends 'base.html' %}

{% block content %}
    <h1 class="theme-page-title text-3xl font-bold mb-6">Manage Users</h1>
    <div class="theme-card shadow-lg rounded-lg overflow-x-auto">
        <table id="users-table" class="min-w-full leading-normal theme-table">
            <thead>
                <tr>
                    <th class="px-5 py-3 border-b-2 theme-table-header-cell text-left text-xs font-semibold uppercase tracking-wider">
                        ID
                    </th>
                    <th class="px-5 py-3 border-b-2 theme-table-header-cell text-left text-xs font-semibold uppercase tracking-wider">
                        Username
                    </th>
                    <th class="px-5 py-3 border-b-2 theme-table-header-cell text-left text-xs font-semibold uppercase tracking-wider">
                        Email
                    </th>
                    <th class="px-5 py-3 border-b-2 theme-table-header-cell text-left text-xs font-semibold uppercase tracking-wider">
                        Score
                    </th>
                    <th class="px-5 py-3 border-b-2 theme-table-header-cell text-left text-xs font-semibold uppercase tracking-wider">
                        Admin
                    </th>
                    <th class="px-5 py-3 border-b-2 theme-table-header-cell text-left text-xs font-semibold uppercase tracking-wider">
                        Hidden
                    </th>
                </tr>
            </thead>
            <tbody>
                {% for user in users %}
                    <tr class="user-row cursor-pointer hover:bg-gray-700" data-user-id="{{ user.id }}" data-is-admin="{{ 'true' if user.is_admin else 'false' }}" data-is-super-admin="{{ 'true' if user.is_super_admin else 'false' }}" data-is-hidden="{{ 'true' if user.hidden else 'false' }}" data-is-banned="{{ 'true' if user.is_banned else 'false' }}">
                        <td class="px-5 py-5 text-sm theme-table-body-cell">
                            <p class="whitespace-no-wrap">{{ user.id }}</p>
                        </td>
                        <td class="px-5 py-5 text-sm theme-table-body-cell">
                            <p class="whitespace-no-wrap">{{ user.username }} {% if user.is_super_admin %}<span class="text-purple-400">(Super)</span>{% endif %}</p>
                        </td>
                        <td class="px-5 py-5 text-sm theme-table-body-cell">
                            <p class="whitespace-no-wrap">{{ user.email if user.email else 'N/A' }}</p>
                        </td>
                        <td class="px-5 py-5 text-sm theme-table-body-cell">
                            <p class="whitespace-no-wrap">{{ user.score }}</p>
                        </td>
                        <td class="px-5 py-5 border-b border-gray-700 bg-gray-800 text-sm">
                            {% if user.is_admin %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-green-100 text-green-800">Yes</span>
                            {% else %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-red-100 text-red-800">No</span>
                            {% endif %}
                        </td>
                        <td class="px-5 py-5 border-b border-gray-700 bg-gray-800 text-sm">
                            {% if user.hidden %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-yellow-100 text-yellow-800">Yes</span>
                            {% else %}
                                <span class="px-2 inline-flex text-xs leading-5 font-semibold rounded-full bg-blue-100 text-blue-800">No</span>
                            {% endif %}
                        </td>
                    </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <div id="user-actions-dropdown" class="absolute z-10 bg-gray-700 rounded-md shadow-lg py-1 hidden">
        <form id="toggle-hidden-form" method="POST" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">
            <button type="submit" class="w-full text-left" id="toggle-hidden-button"></button>
        </form>
        <form id="toggle-ban-form" method="POST" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">
            <button type="submit" class="w-full text-left" id="toggle-ban-button"></button>
        </form>
        <form id="reset-password-form" method="POST" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">
            <button type="submit" class="w-full text-left" id="reset-password-button">Reset Password</button>
        </form>
        <form id="toggle-admin-form" method="POST" class="block px-4 py-2 text-sm text-gray-200 hover:bg-gray-600">
            <button type="submit" class="w-full text-left" id="toggle-admin-button"></button>
        </form>
    </div>
    <script>
        window.isCurrentUserSuperAdmin = {{ is_current_user_super_admin | tojson }};
        window.usersSuperAdminStatus = {{ users_super_admin_status | tojson }};
        window.currentLoggedInUserId = {{ current_user.id | tojson }};

        // Generic error logging for debugging
        window.addEventListener('error', function(event) {
            console.error('Unhandled JavaScript error:', event.error);
        });
    </script>
    <script src="{{ url_for('static', filename='js/admin.js') }}"></script>
{% endblock %}
